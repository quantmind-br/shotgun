# Test Design: Story 2.1 - Template Discovery & Loading System

**Date:** 2025-09-03  
**Designer:** Quinn (Test Architect)  
**Story:** 2.1 - Template Discovery & Loading System

## Test Strategy Overview

Based on acceptance criteria analysis and risk profile assessment:

- **Total test scenarios:** 24
- **Unit tests:** 19 (79%) - High due to security and validation logic
- **Integration tests:** 8 (33%) - Component interaction focus
- **E2E tests:** 2 (8%) - Minimal UI dependency
- **Priority distribution:** P0: 11, P1: 8, P2: 4, P3: 1

**Risk-Based Focus:** Critical security risks (SEC-001, DATA-001) drive comprehensive unit test coverage for path validation and TOML parsing.

## Test Scenarios by Acceptance Criteria

### AC1: Built-in templates embedded in binary from templates/ directory

#### Core Functionality Tests

| ID            | Level       | Priority | Test                                    | Justification                               | Risk Coverage |
|---------------|-------------|----------|----------------------------------------|---------------------------------------------|---------------|
| 2.1-UNIT-001  | Unit        | P0       | Validate embedded templates load       | Core functionality - business critical      | TECH-001      |
| 2.1-UNIT-002  | Unit        | P0       | Extract embedded filesystem contents   | Pure Go embed logic validation              | TECH-001      |
| 2.1-UNIT-003  | Unit        | P1       | Handle missing embedded directory      | Error handling for build issues             | TECH-001      |
| 2.1-INT-001   | Integration | P0       | Built-in template discovery flow       | Multi-component template loading flow       | TECH-001      |

**Test Details:**
- **2.1-UNIT-001**: Verify embed.FS correctly loads template files from embedded directory
- **2.1-UNIT-002**: Test extraction and parsing of embedded .toml files
- **2.1-UNIT-003**: Graceful degradation when templates/ directory missing from build
- **2.1-INT-001**: End-to-end built-in template discovery and parsing integration

### AC2: User templates discovered from ~/.config/shotgun-cli/templates

#### Path Security Tests (Critical - SEC-001 Risk Mitigation)

| ID            | Level       | Priority | Test                                    | Justification                               | Risk Coverage |
|---------------|-------------|----------|----------------------------------------|---------------------------------------------|---------------|
| 2.1-UNIT-004  | Unit        | P0       | Cross-platform path resolution         | Path security critical (SEC-001 risk)      | SEC-001       |
| 2.1-UNIT-005  | Unit        | P0       | Validate path traversal protection     | Critical security vulnerability             | SEC-001       |
| 2.1-UNIT-006  | Unit        | P1       | Windows vs Unix path handling          | Platform compatibility                      | OPS-001       |
| 2.1-UNIT-007  | Unit        | P2       | Directory creation permissions         | Error handling for filesystem access       | OPS-003       |
| 2.1-INT-002   | Integration | P0       | User template directory scanning       | File system interaction                     | SEC-001       |
| 2.1-INT-003   | Integration | P1       | Template directory creation flow       | Cross-platform path creation               | OPS-001       |

**Security Test Details:**
- **2.1-UNIT-004**: Test getUserTemplatesDir() with platform-specific paths
- **2.1-UNIT-005**: **CRITICAL** - Path injection prevention with "../", absolute paths
- **2.1-UNIT-006**: Path separator handling across Windows/Unix systems  
- **2.1-INT-002**: **CRITICAL** - Directory scanning with path validation
- Must include fuzzing tests with malicious path inputs

### AC3: TOML parser correctly reads template metadata

#### Content Security Tests (Critical - DATA-001 Risk Mitigation)

| ID            | Level       | Priority | Test                                    | Justification                               | Risk Coverage |
|---------------|-------------|----------|----------------------------------------|---------------------------------------------|---------------|
| 2.1-UNIT-008  | Unit        | P0       | Parse valid TOML template structure    | Core parsing functionality                  | DATA-001      |
| 2.1-UNIT-009  | Unit        | P0       | Parse template variables from TOML     | Variable handling critical for app         | DATA-001      |
| 2.1-UNIT-010  | Unit        | P0       | Handle malformed TOML gracefully       | Security risk (DATA-001) mitigation       | DATA-001      |
| 2.1-UNIT-011  | Unit        | P1       | Parse complex template content         | Content processing validation               | DATA-001      |
| 2.1-UNIT-012  | Unit        | P2       | Handle oversized TOML files            | Resource exhaustion protection              | DATA-001      |

**Content Security Details:**
- **2.1-UNIT-008**: Valid TOML with all required fields (name, version, description, content)
- **2.1-UNIT-009**: Variable parsing with type validation (text, multiline, choice, etc.)
- **2.1-UNIT-010**: **CRITICAL** - Malformed TOML rejection without app crash
- **2.1-UNIT-012**: **CRITICAL** - File size limits (1MB max) enforcement
- Must include fuzzing tests with malicious TOML content

### AC4: Template validation ensures required fields are present

#### Data Integrity Tests

| ID            | Level       | Priority | Test                                    | Justification                               | Risk Coverage |
|---------------|-------------|----------|----------------------------------------|---------------------------------------------|---------------|
| 2.1-UNIT-013  | Unit        | P0       | Validate required template fields      | Data integrity critical                     | DATA-002      |
| 2.1-UNIT-014  | Unit        | P0       | Validate variable type consistency     | Type safety for template variables         | DATA-002      |
| 2.1-UNIT-015  | Unit        | P1       | Validate template metadata format      | Template structure validation               | DATA-002      |
| 2.1-INT-004   | Integration | P1       | End-to-end template validation flow    | Validation pipeline testing                 | DATA-002      |

**Validation Test Details:**
- **2.1-UNIT-013**: Required fields: name, version, description, content must be present
- **2.1-UNIT-014**: Variable types (text/multiline/choice/boolean/number) validation
- **2.1-UNIT-015**: Metadata format validation (version format, tag arrays, etc.)
- **2.1-INT-004**: Complete validation pipeline from file to validated Template struct

### AC5: Templates with parsing errors are skipped with warning logs

#### Error Handling Tests

| ID            | Level       | Priority | Test                                    | Justification                               | Risk Coverage |
|---------------|-------------|----------|----------------------------------------|---------------------------------------------|---------------|
| 2.1-UNIT-016  | Unit        | P1       | Skip malformed templates gracefully    | Error handling without app crash           | OPS-002       |
| 2.1-UNIT-017  | Unit        | P1       | Generate appropriate warning logs      | Operational observability                   | OPS-002       |
| 2.1-INT-005   | Integration | P1       | Error aggregation across templates     | Multiple failure handling                   | OPS-002       |

**Error Handling Details:**
- **2.1-UNIT-016**: Continue processing when individual templates fail
- **2.1-UNIT-017**: Structured logging with template file paths and error details
- **2.1-INT-005**: Multiple template failures don't block successful template loading

### AC6: Both built-in and user templates appear in unified list

#### Template Unification Tests

| ID            | Level       | Priority | Test                                    | Justification                               | Risk Coverage |
|---------------|-------------|----------|----------------------------------------|---------------------------------------------|---------------|
| 2.1-UNIT-018  | Unit        | P0       | Merge built-in and user templates      | Core template unification logic            | BUS-001       |
| 2.1-UNIT-019  | Unit        | P0       | Handle template ID deduplication       | User template override logic               | BUS-001       |
| 2.1-INT-006   | Integration | P0       | Complete template loading service      | Full template discovery integration        | BUS-001       |
| 2.1-E2E-001   | E2E         | P1       | Template list displays correctly       | User-facing template selection             | BUS-001       |

**Unification Test Details:**
- **2.1-UNIT-018**: Combine templates from both sources into single sorted list
- **2.1-UNIT-019**: User templates override built-in templates with same ID
- **2.1-INT-006**: LoadAllTemplates() method complete flow testing
- **2.1-E2E-001**: Template selection UI shows unified list (future dependency)

### AC7: Unit tests cover template discovery and parsing logic

#### Quality Assurance Tests

| ID            | Level       | Priority | Test                                    | Justification                               | Risk Coverage |
|---------------|-------------|----------|----------------------------------------|---------------------------------------------|---------------|
| 2.1-INT-007   | Integration | P0       | Test coverage validation (>90%)        | Quality gate requirement                    | N/A           |
| 2.1-INT-008   | Integration | P2       | Concurrent template access testing     | Thread safety validation                    | TECH-003      |
| 2.1-E2E-002   | E2E         | P3       | Full template workflow smoke test      | End-to-end regression prevention           | N/A           |

**Quality Test Details:**
- **2.1-INT-007**: Automated coverage reporting for template packages
- **2.1-INT-008**: sync.Map concurrent access with multiple goroutines
- **2.1-E2E-002**: Complete template discovery â†’ selection â†’ usage workflow

## Critical Security Test Requirements

### Mandatory Security Fuzzing Tests (P0)

Based on critical risks SEC-001 and DATA-001, these additional tests are **required**:

| ID            | Level       | Priority | Test                                    | Justification                               |
|---------------|-------------|----------|----------------------------------------|---------------------------------------------|
| 2.1-FUZZ-001  | Unit        | P0       | Path injection fuzzing                 | SEC-001 path traversal prevention          |
| 2.1-FUZZ-002  | Unit        | P0       | TOML content fuzzing                   | DATA-001 malicious content protection      |
| 2.1-FUZZ-003  | Unit        | P0       | File size boundary testing            | DATA-001 resource exhaustion prevention    |
| 2.1-FUZZ-004  | Unit        | P1       | Unicode path handling                  | Cross-platform path security               |

**Security Fuzzing Details:**
- **2.1-FUZZ-001**: Test with "../../etc/passwd", absolute paths, symlinks
- **2.1-FUZZ-002**: Malformed TOML, nested structures, excessive recursion  
- **2.1-FUZZ-003**: Files >1MB, empty files, binary content
- **2.1-FUZZ-004**: Unicode characters, emoji, multi-byte sequences in paths

### Performance Testing (P1)

| ID            | Level       | Priority | Test                                    | Justification                               |
|---------------|-------------|----------|----------------------------------------|---------------------------------------------|
| 2.1-LOAD-001  | Integration | P1       | Memory profiling with 1000+ templates | PERF-001 cache exhaustion prevention       |
| 2.1-LOAD-002  | Integration | P1       | Concurrent access stress testing       | PERF-001 and TECH-003 risk mitigation     |
| 2.1-LOAD-003  | Integration | P2       | Cache eviction behavior validation     | PERF-001 memory management                  |

## Risk Coverage Analysis

### Critical Risk Coverage (Score 9) - **Must Pass**

**SEC-001 (Path Traversal Vulnerability):**
- Primary: 2.1-UNIT-004, 2.1-UNIT-005, 2.1-INT-002
- Security: 2.1-FUZZ-001, 2.1-FUZZ-004
- **Gate Impact**: Any failure in these tests = **FAIL**

**DATA-001 (TOML Content Injection):**
- Primary: 2.1-UNIT-010, 2.1-UNIT-012, 2.1-INT-005
- Security: 2.1-FUZZ-002, 2.1-FUZZ-003
- **Gate Impact**: Any failure in these tests = **FAIL**

### High Risk Coverage (Score 6) - **Must Address**

**TECH-001 (Go Embed Reliability):**
- Coverage: 2.1-UNIT-001, 2.1-UNIT-002, 2.1-INT-001
- **Gate Impact**: Failure = **CONCERNS**

**PERF-001 (Cache Memory Exhaustion):**
- Coverage: 2.1-LOAD-001, 2.1-LOAD-002, 2.1-INT-008
- **Gate Impact**: Failure = **CONCERNS**

**OPS-001 (Cross-platform Path Issues):**
- Coverage: 2.1-UNIT-006, 2.1-INT-003
- **Gate Impact**: Failure = **CONCERNS**

## Test Execution Strategy

### Phase 1: Critical Security Foundation (P0 - Must Pass)
**Execute First - Fail Fast on Security Issues**

1. **Security Unit Tests:**
   - 2.1-UNIT-004: Path resolution security
   - 2.1-UNIT-005: Path traversal protection
   - 2.1-UNIT-010: Malformed TOML handling
   - 2.1-UNIT-012: File size protection

2. **Security Fuzzing:**
   - 2.1-FUZZ-001: Path injection attacks
   - 2.1-FUZZ-002: TOML content injection
   - 2.1-FUZZ-003: Resource exhaustion

3. **Core Validation:**
   - 2.1-UNIT-013: Required field validation
   - 2.1-UNIT-014: Type consistency

**Exit Criteria**: 100% pass rate for security tests

### Phase 2: Core Functionality (P0)
**Core Business Logic Validation**

1. **Template Processing:**
   - 2.1-UNIT-001: Embedded template loading
   - 2.1-UNIT-008: TOML parsing
   - 2.1-UNIT-018: Template unification

2. **Integration Flows:**
   - 2.1-INT-001: Built-in template discovery
   - 2.1-INT-002: User template scanning
   - 2.1-INT-006: Complete loading service
   - 2.1-INT-007: Coverage validation

**Exit Criteria**: >90% pass rate, all critical paths working

### Phase 3: High Priority Features (P1)
**Platform Compatibility and Performance**

1. **Cross-platform Testing:**
   - 2.1-UNIT-006: Windows vs Unix paths
   - 2.1-INT-003: Directory creation flow

2. **Performance Testing:**
   - 2.1-LOAD-001: Memory profiling
   - 2.1-LOAD-002: Concurrent access

3. **Error Handling:**
   - 2.1-UNIT-016: Graceful error handling
   - 2.1-UNIT-017: Warning logs

**Exit Criteria**: >80% pass rate, performance within limits

### Phase 4: Secondary Features (P2/P3)
**Execute as Time Permits**

1. **Edge Cases and Polish:**
   - All P2 tests
   - 2.1-E2E-002: End-to-end smoke test

**Exit Criteria**: Best effort, document any skipped tests

## Test Environment Requirements

### Development Environment
- **Go 1.22+** with testing framework
- **Testdata directory** with sample templates
- **Mock filesystem** utilities for unit tests
- **Cross-platform CI** (Windows, macOS, Linux)

### Test Data Requirements

#### Valid Template Samples (testdata/valid/)
```
â”œâ”€â”€ basic-template.toml          # Minimal valid template
â”œâ”€â”€ complex-template.toml        # Full feature template
â”œâ”€â”€ variable-types.toml          # All variable types
â”œâ”€â”€ unicode-content.toml         # International characters
â””â”€â”€ large-template.toml          # Near size limits
```

#### Security Test Samples (testdata/security/)
```
â”œâ”€â”€ path-traversal/
â”‚   â”œâ”€â”€ dotdot-attack.toml      # ../../../etc/passwd
â”‚   â”œâ”€â”€ absolute-path.toml      # /etc/passwd
â”‚   â””â”€â”€ symlink-attack.toml     # Symlink exploitation
â”œâ”€â”€ content-injection/
â”‚   â”œâ”€â”€ malformed.toml          # Invalid TOML syntax
â”‚   â”œâ”€â”€ oversized.toml          # >1MB file
â”‚   â””â”€â”€ nested-bomb.toml        # Excessive nesting
â””â”€â”€ unicode/
    â”œâ”€â”€ emoji-paths.toml        # Emoji in file paths
    â””â”€â”€ multibyte.toml          # Multi-byte characters
```

#### Platform Test Samples (testdata/platforms/)
```
â”œâ”€â”€ windows-paths.toml          # Windows path patterns
â”œâ”€â”€ unix-paths.toml            # Unix path patterns
â””â”€â”€ mixed-separators.toml      # Mixed path separators
```

### CI/CD Integration Requirements

#### Security Gate Integration
- **Pre-commit**: Run security fuzzing on every commit
- **PR Gate**: Full security test suite must pass
- **Security Scan**: Static analysis for path handling code

#### Performance Baseline
- **Memory Limit**: Template cache <100MB for 1000 templates
- **Load Time**: <500ms for template discovery
- **Concurrent Access**: >100 req/sec without degradation

## Test Maintenance Strategy

### Test Data Management
- **Version Control**: All test templates in Git
- **Template Updates**: Update test data when template format changes
- **Security Updates**: Regular review of attack patterns

### Continuous Improvement
- **Production Monitoring**: Track template loading failures
- **User Feedback**: Incorporate reported edge cases
- **Security Reviews**: Quarterly security test updates

## Coverage Gaps and Recommendations

### Current Coverage Strengths
âœ… **Comprehensive security testing** for critical vulnerabilities  
âœ… **Multi-level testing** with appropriate test boundaries  
âœ… **Risk-based prioritization** focusing on high-impact areas  
âœ… **Cross-platform validation** for portability  

### Identified Gaps (Future Enhancements)
âš ï¸ **Chaos Engineering**: Template system resilience under failures  
âš ï¸ **Accessibility Testing**: Future template UI compliance  
âš ï¸ **Localization Testing**: International template content support  
âš ï¸ **Migration Testing**: Template format version upgrades  

### Must-Add Before Production
ðŸš¨ **Security Penetration Testing**: Professional security review  
ðŸš¨ **Load Testing**: Production-scale template sets  
ðŸš¨ **Disaster Recovery**: Template corruption and recovery  

## Quality Gate Integration

This test design directly feeds into the quality gate decision with:

### Automatic FAIL Conditions
- Any critical security test failure (SEC-001, DATA-001)
- Template loading completely broken
- Cross-platform path resolution failures

### Automatic CONCERNS Conditions
- Performance tests exceed baseline limits
- Embed system reliability issues
- >10% of P1 tests failing

### Test Coverage Metrics for Gate
- **P0 Test Pass Rate**: Must be 100%
- **Overall Unit Coverage**: Must be >90%
- **Security Test Coverage**: Must be 100%
- **Integration Test Pass Rate**: Must be >80%

## Summary

This test design provides comprehensive coverage for Story 2.1 with particular emphasis on the critical security risks identified in the risk profile. The **24 test scenarios** are strategically distributed across test levels to maximize efficiency while ensuring robust validation of the template discovery and loading system.

**Key Success Factors:**
1. **Security-First Approach**: Critical risks drive test prioritization
2. **Efficient Test Distribution**: Right tests at the right level
3. **Risk-Based Execution**: High-risk areas tested first
4. **Quality Gate Integration**: Clear pass/fail criteria
5. **Comprehensive Coverage**: All acceptance criteria addressed