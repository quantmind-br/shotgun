# Test Design: Story 4.4 - Init Command & Shotgunignore Support

**Date**: 2025-09-05  
**Designer**: Quinn (Test Architect)  
**Story**: 4.4.init-command-shotgunignore-support.story.md

## Test Strategy Overview

- **Total test scenarios**: 18
- **Unit tests**: 8 (44%)
- **Integration tests**: 7 (39%)
- **E2E tests**: 3 (17%)
- **Priority distribution**: P0: 6, P1: 8, P2: 4

## Test Scenarios by Acceptance Criteria

### AC1: 'shotgun init' command creates .shotgunignore file

#### Scenarios

| ID            | Level       | Priority | Test                                    | Justification                    |
| ------------- | ----------- | -------- | --------------------------------------- | -------------------------------- |
| 4.4-UNIT-001  | Unit        | P0       | CreateShotgunignore creates file        | Core file creation logic         |
| 4.4-UNIT-002  | Unit        | P0       | File path validation prevents traversal | Critical security (SEC-001)      |
| 4.4-INT-001   | Integration | P0       | CLI command executes file creation      | Command-to-logic integration     |
| 4.4-E2E-001   | E2E         | P1       | User runs 'shotgun init' successfully  | Critical user journey            |

### AC2: Template .shotgunignore includes common patterns

#### Scenarios

| ID            | Level       | Priority | Test                                | Justification                 |
| ------------- | ----------- | -------- | ----------------------------------- | ----------------------------- |
| 4.4-UNIT-003  | Unit        | P1       | Template contains expected patterns | Template content validation   |
| 4.4-UNIT-004  | Unit        | P2       | Pattern categories properly labeled | Content organization quality |

### AC3: File created only if it doesn't exist

#### Scenarios

| ID            | Level       | Priority | Test                                   | Justification                |
| ------------- | ----------- | -------- | -------------------------------------- | ---------------------------- |
| 4.4-UNIT-005  | Unit        | P0       | File existence check prevents overwrite | Core safety logic           |
| 4.4-UNIT-006  | Unit        | P1       | Force flag bypasses existence check    | Override behavior validation |
| 4.4-INT-002   | Integration | P1       | CLI respects existing file             | End-to-end safety behavior   |

### AC4: Success message confirms file creation

#### Scenarios

| ID            | Level       | Priority | Test                              | Justification          |
| ------------- | ----------- | -------- | --------------------------------- | ---------------------- |
| 4.4-UNIT-007  | Unit        | P2       | Success message format correct    | User feedback quality  |
| 4.4-INT-003   | Integration | P1       | CLI displays success message      | Command output testing |

### AC5: Command available via Cobra CLI framework

#### Scenarios

| ID            | Level       | Priority | Test                                | Justification              |
| ------------- | ----------- | -------- | ----------------------------------- | -------------------------- |
| 4.4-INT-004   | Integration | P0       | Cobra registers init command        | CLI framework integration  |
| 4.4-INT-005   | Integration | P1       | Command parsing handles arguments   | Argument processing        |
| 4.4-E2E-002   | E2E         | P1       | CLI mode vs TUI mode switching      | Entry point behavior       |

### AC6: Help text explains usage and purpose

#### Scenarios

| ID            | Level       | Priority | Test                          | Justification         |
| ------------- | ----------- | -------- | ----------------------------- | --------------------- |
| 4.4-UNIT-008  | Unit        | P2       | Help text content validation  | Documentation quality |
| 4.4-INT-006   | Integration | P2       | Help command displays text    | Help system function  |

### AC7: Integration with main file scanner confirmed

#### Scenarios

| ID            | Level       | Priority | Test                                        | Justification                    |
| ------------- | ----------- | -------- | ------------------------------------------- | -------------------------------- |
| 4.4-INT-007   | Integration | P0       | Scanner reads created .shotgunignore        | Core feature functionality       |
| 4.4-E2E-003   | E2E         | P1       | End-to-end: init → scan → patterns ignored | Complete workflow validation     |

## Risk Coverage

**Mapping test scenarios to identified risks from risk profile:**

### SEC-001: File System Path Traversal (Score: 6 - High Risk)
- **4.4-UNIT-002**: File path validation prevents traversal - **P0 Critical**
- Covers malicious path inputs like `../../../etc/passwd`
- Validates filepath.Clean() and working directory restrictions

### TECH-001: CLI Framework Integration (Score: 4 - Medium Risk)  
- **4.4-INT-004**: Cobra registers init command - **P0**
- **4.4-E2E-002**: CLI vs TUI mode switching - **P1**
- Ensures backward compatibility maintained

### OPS-001: Cross-Platform File Permissions (Score: 4 - Medium Risk)
- **4.4-UNIT-001**: CreateShotgunignore creates file - **P0**
- **4.4-INT-001**: CLI command executes file creation - **P0**  
- Tests across Windows/macOS/Linux in CI pipeline

### TECH-002: Scanner Integration Validation (Score: 4 - Medium Risk)
- **4.4-INT-007**: Scanner reads created .shotgunignore - **P0**
- **4.4-E2E-003**: End-to-end workflow validation - **P1**
- Verifies actual integration works as expected

## Detailed Test Specifications

### P0 Critical Tests (Execute First)

#### 4.4-UNIT-001: CreateShotgunignore creates file
```go
func TestCreateShotgunignore_CreatesFile(t *testing.T) {
    // Setup temp directory
    // Call CreateShotgunignore()  
    // Assert file exists with correct content
    // Assert file permissions (0644)
}
```

#### 4.4-UNIT-002: File path validation prevents traversal
```go
func TestCreateShotgunignore_PathTraversalPrevention(t *testing.T) {
    maliciousPaths := []string{
        "../../../etc/passwd",
        "/etc/passwd", 
        "..\\..\\windows\\system32\\hosts",
        ".shotgunignore/../malicious",
    }
    // Assert all return errors, no files created outside working dir
}
```

#### 4.4-UNIT-005: File existence check prevents overwrite
```go
func TestCreateShotgunignore_PreservesExistingFile(t *testing.T) {
    // Create existing .shotgunignore with custom content
    // Call CreateShotgunignore() 
    // Assert original content preserved
    // Assert returns appropriate error/message
}
```

#### 4.4-INT-001: CLI command executes file creation
```go
func TestInitCommand_ExecutesFileCreation(t *testing.T) {
    // Execute: shotgun init
    // Assert file created in working directory  
    // Assert command exits with 0
}
```

#### 4.4-INT-004: Cobra registers init command  
```go
func TestCobraRegistration_InitCommandAvailable(t *testing.T) {
    // Create root command
    // Assert init subcommand registered
    // Assert command metadata correct
}
```

#### 4.4-INT-007: Scanner reads created .shotgunignore
```go
func TestScannerIntegration_ReadsCreatedIgnoreFile(t *testing.T) {
    // Create .shotgunignore with test patterns
    // Run scanner on test directory  
    // Assert patterns respected in scan results
}
```

### P1 High Priority Tests

#### 4.4-E2E-001: User runs 'shotgun init' successfully
```bash
# Test script: Complete user journey
$ shotgun init
✓ Created .shotgunignore file
$ cat .shotgunignore
# Verify template content present
```

#### 4.4-E2E-002: CLI vs TUI mode switching
```bash  
# Test script: Entry point behavior
$ shotgun              # Should launch TUI mode
$ shotgun init          # Should execute CLI command
$ shotgun --help        # Should show CLI help
```

### P2 Medium Priority Tests  

Focus on polish and user experience validation:
- Help text quality
- Template content organization  
- User feedback messages

## Cross-Platform Test Matrix

**Required testing across platforms (addresses OPS-001 risk):**

| Test Scenario   | Windows | macOS | Linux | Priority |
| --------------- | ------- | ----- | ----- | -------- |
| File creation   | ✓       | ✓     | ✓     | P0       |
| Path validation | ✓       | ✓     | ✓     | P0       |
| CLI execution   | ✓       | ✓     | ✓     | P0       |
| TUI fallback    | ✓       | ✓     | ✓     | P1       |

## Security Test Scenarios (SEC-001 Mitigation)

**Comprehensive path traversal testing:**

```go
var maliciousInputs = []struct {
    input     string
    shouldErr bool
    desc      string
}{
    {"../../../etc/passwd", true, "Unix path traversal"},
    {"..\\..\\..\\windows\\system32\\hosts", true, "Windows path traversal"},
    {"/etc/passwd", true, "Absolute path outside working dir"},
    {"./subdir/../.shotgunignore", false, "Safe relative path"},
    {".shotgunignore", false, "Normal filename"},
    {"", true, "Empty filename"},
    {"con.txt", true, "Windows reserved name"},
}
```

## Performance Test Considerations

**For P0 file operations:**
- File creation should complete <100ms
- CLI command execution should complete <500ms  
- Scanner integration should not impact scan performance >10%

## Recommended Execution Order

1. **P0 Unit tests** (fail fast on core logic)
   - Path validation security tests first
   - File creation logic  
   - Safety checks

2. **P0 Integration tests** (critical integrations)
   - CLI command registration
   - File creation via CLI
   - Scanner integration

3. **P1 E2E tests** (user journeys)  
   - Complete init workflow
   - CLI/TUI mode switching

4. **P1 Integration tests** (supporting features)
   - Help system
   - Error handling
   - Force flag behavior

5. **P2 tests** (polish and quality)
   - Message formatting
   - Template content validation

## Test Environment Requirements

**Unit Tests:**
- Temp directories for file operations
- Mock file system for error scenarios
- Cross-platform path testing

**Integration Tests:**  
- Real CLI execution environment
- Temporary working directories
- Scanner test fixtures

**E2E Tests:**
- Full binary execution
- Real file system operations  
- Platform-specific environments (CI matrix)

## Coverage Expectations

| Test Level    | Coverage Target | Critical Components           |
| ------------- | --------------- | ----------------------------- |
| Unit          | >90%            | CreateShotgunignore, validation |
| Integration   | >85%            | CLI commands, scanner integration |
| E2E           | 100%            | All critical user paths       |

## Maintenance Considerations

**Test stability factors:**
- File system operations require cleanup
- Cross-platform path handling requires careful assertions
- CLI testing needs process management
- Scanner integration tests need predictable test data

**Test data management:**
- Template content should be sourced from actual template
- Test directories should be isolated and cleaned up
- Scanner test fixtures should represent real project structures