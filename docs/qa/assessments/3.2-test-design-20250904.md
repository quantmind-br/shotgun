# Test Design: Story 3.2 File Structure Assembly

**Date**: 2025-09-04  
**Designer**: Quinn (Test Architect)  
**Story**: File Structure Assembly - Include selected files with content in prompt for LLM analysis

## Test Strategy Overview

- **Total test scenarios**: 13
- **Unit tests**: 5 (38%) - Core logic and algorithms  
- **Integration tests**: 5 (38%) - Component interactions
- **E2E tests**: 3 (24%) - Critical user journeys
- **Priority distribution**: P0: 5, P1: 7, P2: 3

## Test Scenarios by Acceptance Criteria

### AC1: Generate tree-like structure showing directory hierarchy

#### Scenarios

| ID           | Level       | Priority | Test                           | Justification                    |
| ------------ | ----------- | -------- | ------------------------------ | -------------------------------- |
| 3.2-UNIT-001 | Unit        | P0       | Tree structure generation logic | Pure algorithm - perfect for unit testing |
| 3.2-INT-001  | Integration | P0       | File system tree building       | Real file I/O needed for validation |
| 3.2-E2E-001  | E2E         | P1       | Complete assembly flow          | Critical path validation          |

### AC2: Use ASCII characters for tree visualization (├── └── │)

#### Scenarios

| ID           | Level       | Priority | Test                           | Justification                    |
| ------------ | ----------- | -------- | ------------------------------ | -------------------------------- |
| 3.2-UNIT-002 | Unit        | P1       | ASCII character selection logic | String formatting logic         |
| 3.2-E2E-001  | E2E         | P1       | Visual output validation        | End-to-end visual correctness   |

### AC3: Read file contents asynchronously using goroutines

#### Scenarios

| ID           | Level       | Priority | Test                           | Justification                    |
| ------------ | ----------- | -------- | ------------------------------ | -------------------------------- |
| 3.2-INT-002  | Integration | P0       | Worker pool coordination        | Concurrency requires integration test |
| 3.2-INT-005  | Integration | P1       | Context cancellation handling   | Cross-goroutine coordination    |
| 3.2-E2E-001  | E2E         | P1       | Async processing flow           | User experience validation      |
| 3.2-E2E-002  | E2E         | P2       | Large project processing        | Performance under realistic load |

### AC4: Wrap file contents in `<file path="...">content</file>` tags

#### Scenarios

| ID           | Level       | Priority | Test                           | Justification                    |
| ------------ | ----------- | -------- | ------------------------------ | -------------------------------- |
| 3.2-UNIT-004 | Unit        | P0       | XML content escaping           | Complex string transformation   |
| 3.2-E2E-001  | E2E         | P1       | XML output validation           | End-to-end format correctness   |

### AC5: Skip binary files with appropriate message

#### Scenarios

| ID           | Level       | Priority | Test                           | Justification                    |
| ------------ | ----------- | -------- | ------------------------------ | -------------------------------- |
| 3.2-UNIT-003 | Unit        | P0       | Binary detection logic          | Complex classification algorithm |
| 3.2-INT-004  | Integration | P1       | Scanner service integration     | Component boundary testing      |
| 3.2-E2E-003  | E2E         | P2       | Binary file user experience    | Error handling UX validation    |

### AC6: Handle large files gracefully (streaming read)

#### Scenarios

| ID           | Level       | Priority | Test                           | Justification                    |
| ------------ | ----------- | -------- | ------------------------------ | -------------------------------- |
| 3.2-UNIT-005 | Unit        | P0       | File size limit validation      | Critical resource protection    |
| 3.2-INT-001  | Integration | P0       | Streaming file I/O              | Real file system interaction   |
| 3.2-INT-005  | Integration | P1       | Large file cancellation         | Resource management correctness |
| 3.2-E2E-002  | E2E         | P2       | Large file user experience      | Performance characteristics     |

### AC7: Preserve exact file content including whitespace

#### Scenarios

| ID           | Level       | Priority | Test                           | Justification                    |
| ------------ | ----------- | -------- | ------------------------------ | -------------------------------- |
| 3.2-INT-001  | Integration | P0       | Content preservation validation | File I/O fidelity testing       |
| 3.2-E2E-001  | E2E         | P1       | End-to-end content accuracy     | Complete flow validation        |

## Risk Coverage

**Critical Risks Addressed:**

- **PERF-001** (Memory exhaustion): 3.2-UNIT-005, 3.2-INT-001, 3.2-E2E-002
- **DATA-002** (Sensitive file exposure): 3.2-INT-001, 3.2-E2E-003
- **TECH-001** (Goroutine pool exhaustion): 3.2-INT-002, 3.2-E2E-002

**High Risks Addressed:**

- **TECH-003** (XML escaping bugs): 3.2-UNIT-004
- **PERF-003** (I/O bottlenecks): 3.2-INT-002, 3.2-E2E-002
- **DATA-001** (Content corruption): 3.2-INT-001, 3.2-E2E-001

## Detailed Test Scenarios

### Unit Tests (P0 Priority)

**3.2-UNIT-001: Tree Structure Generation Logic**
- **Test Cases**: Empty directories, single files, nested structures, deeply nested paths
- **Assertions**: Correct parent-child relationships, proper indentation levels, accurate hierarchy representation
- **Mock Requirements**: None - pure algorithm testing
- **Risk Mitigation**: Validates core tree building logic

**3.2-UNIT-003: Binary File Detection Logic**
- **Test Cases**: Common binary types (images, executables, archives), text files, edge cases (empty files, large files)
- **Assertions**: Correct binary/text classification, proper error messages
- **Mock Requirements**: File content simulation
- **Risk Mitigation**: Prevents binary file processing corruption

**3.2-UNIT-004: XML Content Escaping** 
- **Test Cases**: Special XML characters (&, <, >, ", '), Unicode characters, control characters
- **Assertions**: Proper escaping, valid XML output, no data loss
- **Mock Requirements**: None - string transformation testing
- **Risk Mitigation**: Critical for data integrity and XML parsing

**3.2-UNIT-005: File Size Limit Validation**
- **Test Cases**: Files at threshold, over/under limits, zero-size files, negative sizes
- **Assertions**: Correct size comparison, proper limit enforcement
- **Mock Requirements**: File size simulation  
- **Risk Mitigation**: Prevents memory exhaustion attacks

### Integration Tests (P0/P1 Priority)

**3.2-INT-001: File System Integration**
- **Test Environment**: Temporary directory with known file structure
- **Test Cases**: Various file types, permissions, sizes, encoding
- **Assertions**: Accurate file reading, correct content preservation, proper error handling
- **Risk Mitigation**: Validates real-world file I/O behavior

**3.2-INT-002: Goroutine Worker Pool Integration**
- **Test Environment**: Multiple test files triggering concurrent processing
- **Test Cases**: Pool saturation, worker coordination, resource cleanup
- **Assertions**: Correct concurrency control, no goroutine leaks, proper task distribution
- **Risk Mitigation**: Prevents resource exhaustion and deadlocks

### End-to-End Tests (P1/P2 Priority) 

**3.2-E2E-001: Complete File Structure Assembly Flow**
- **Test Environment**: Full application with UI and template processing
- **User Journey**: Select files → trigger assembly → review output → validate format
- **Assertions**: Complete workflow success, correct output format, proper UI feedback
- **Risk Mitigation**: Validates entire user experience

**3.2-E2E-002: Large Project Processing**
- **Test Environment**: Simulated project with 100+ files including large ones
- **Performance Metrics**: Processing time, memory usage, resource cleanup
- **Assertions**: Acceptable performance, no crashes, proper progress feedback
- **Risk Mitigation**: Validates scalability characteristics

## Recommended Execution Order

### Phase 1: Critical Path Validation (P0)
1. **3.2-UNIT-001**: Tree generation logic
2. **3.2-UNIT-003**: Binary file detection  
3. **3.2-UNIT-004**: XML escaping
4. **3.2-UNIT-005**: File size limits
5. **3.2-INT-001**: File system integration
6. **3.2-INT-002**: Goroutine coordination

### Phase 2: Core Experience (P1)  
7. **3.2-UNIT-002**: ASCII character formatting
8. **3.2-INT-003**: Template engine integration
9. **3.2-INT-004**: Scanner service integration  
10. **3.2-INT-005**: Context cancellation
11. **3.2-E2E-001**: Complete user flow

### Phase 3: Performance & Edge Cases (P2)
12. **3.2-E2E-002**: Large project processing
13. **3.2-E2E-003**: Error recovery flow

## Test Environment Requirements

**Unit Tests:**
- No external dependencies
- Mock file systems and content
- Fast execution (<100ms per test)

**Integration Tests:**  
- Temporary file system access
- Controlled test data files
- Moderate execution time (<5s per test)

**E2E Tests:**
- Full application environment
- Realistic test project structures
- Longer execution acceptable (30s-2min)

## Coverage Targets

- **Unit Test Coverage**: >90% of core logic functions
- **Integration Coverage**: All component boundaries tested  
- **E2E Coverage**: All critical user paths validated
- **Risk Coverage**: All critical/high risks have test coverage

## Maintenance Considerations

**Test Data Management:**
- Use embedded test fixtures for unit tests
- Generate temporary structures for integration tests
- Clean up test files automatically

**Test Stability:**
- Mock external dependencies where possible
- Use deterministic test data  
- Implement proper test isolation
- Add retry logic for timing-sensitive tests

**Performance Monitoring:**
- Track test execution times
- Monitor resource usage during tests
- Alert on significant performance degradation