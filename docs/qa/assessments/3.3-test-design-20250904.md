# Test Design: Story 3.3 - Confirmation Screen with Size Estimation

**Date**: September 4, 2025  
**Designer**: Quinn (Test Architect)  
**Story**: 3.3 - Confirmation Screen with Size Estimation  
**Status**: Approved

## Test Strategy Overview

- **Total test scenarios**: 22
- **Unit tests**: 9 (41%) - Core logic and calculations
- **Integration tests**: 8 (36%) - Component interactions  
- **E2E tests**: 5 (23%) - User journeys and workflows
- **Priority distribution**: P0: 9, P1: 8, P2: 2, P3: 0

**Test Philosophy**: Risk-based testing focused on size estimation accuracy, UI performance, and critical user workflows. Comprehensive coverage across all test levels with emphasis on performance validation.

## Test Scenarios by Acceptance Criteria

### AC1: Display Summary of Selections

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.3-INT-004 | Integration | P0 | AppState data synchronization | Critical data flow validation |
| 3.3-INT-003 | Integration | P1 | Binary file exclusion display | Multi-component integration |
| 3.3-E2E-001 | E2E | P0 | Complete confirmation flow | End-to-end summary validation |

### AC2: Calculate and Display Estimated Size

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.3-UNIT-001 | Unit | P0 | EstimatePromptSize basic calculation | Core business logic |
| 3.3-UNIT-002 | Unit | P0 | Template size calculation | Isolated template processing |
| 3.3-UNIT-003 | Unit | P0 | File structure size calculation | Independent calculation algorithm |
| 3.3-UNIT-004 | Unit | P1 | Size formatting (KB/MB display) | Pure formatting logic |
| 3.3-INT-001 | Integration | P0 | Template processing integration | Critical service integration |
| 3.3-INT-002 | Integration | P0 | File size data integration | FileTree metadata integration |
| 3.3-E2E-001 | E2E | P0 | Complete confirmation flow | Realistic size calculation context |

### AC3: Show Output Filename with Timestamp

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.3-UNIT-006 | Unit | P1 | Timestamp filename generation | Pure string formatting logic |
| 3.3-UNIT-007 | Unit | P2 | Filename collision detection | File system independent logic |
| 3.3-INT-004 | Integration | P0 | AppState data synchronization | Filename display integration |
| 3.3-E2E-001 | E2E | P0 | Complete confirmation flow | End-to-end filename validation |

### AC4: Progress Bar Displays During Calculation

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.3-UNIT-009 | Unit | P1 | Progress calculation | Pure mathematical calculation |
| 3.3-INT-006 | Integration | P1 | Progress bar update integration | Async UI component integration |
| 3.3-INT-008 | Integration | P0 | Goroutine size calculation integration | Complex async integration |
| 3.3-E2E-001 | E2E | P0 | Complete confirmation flow | Progress bar in user context |
| 3.3-E2E-002 | E2E | P1 | Large file set performance journey | Performance validation |

### AC5: Warning Appears for Large Outputs

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.3-UNIT-005 | Unit | P0 | Warning threshold detection | Critical business rules |
| 3.3-INT-007 | Integration | P0 | Warning display integration | Business logic + UI integration |
| 3.3-E2E-005 | E2E | P1 | Large output warning journey | Warning effectiveness validation |

### AC6: F10 Confirms and Triggers Generation

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.3-E2E-001 | E2E | P0 | Complete confirmation flow | Critical navigation validation |

### AC7: F2 Allows Returning to Make Adjustments

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.3-INT-005 | Integration | P1 | Screen transition integration | Navigation with state preservation |
| 3.3-E2E-004 | E2E | P1 | Back navigation journey | User workflow validation |

## Risk Coverage Analysis

### Medium Risk Mitigation (Score 4)

**PERF-001** (Size calculation blocks UI):
- ✅ 3.3-INT-008: Concurrent processing integration
- ✅ 3.3-E2E-002: Large file set performance validation

**TECH-001** (Complex size estimation inaccuracy):
- ✅ 3.3-UNIT-001/002/003: Core calculation algorithms  
- ✅ 3.3-INT-001: Real template processing integration

**DATA-001** (Inaccurate estimates surprise users):
- ✅ 3.3-UNIT-005: Warning threshold validation
- ✅ 3.3-E2E-005: User warning effectiveness

### Low Risk Coverage (Score 2-3)

**PERF-002** (Memory consumption): Performance testing coverage
**TECH-002** (Race conditions): 3.3-INT-008 concurrent processing tests  
**BUS-001** (LLM performance impact): 3.3-E2E-005 warning journey
**DATA-002** (File permissions): 3.3-E2E-003 error handling journey

## Detailed Test Scenarios

### Unit Tests (9 scenarios)

#### Core Size Estimation Logic

**3.3-UNIT-001: EstimatePromptSize Basic Calculation**
- **Priority**: P0
- **Description**: Test size calculation with template + variables + file structure
- **Input**: Template object, variable map, file list
- **Expected**: Accurate total size estimation with breakdown
- **Edge Cases**: Empty template, no files, large file sets
- **Mitigates**: TECH-001

**3.3-UNIT-002: Template Size Calculation**
- **Priority**: P0  
- **Description**: Process template with variables, calculate character count
- **Input**: Template with variables (TASK, RULES, FILE_STRUCTURE)
- **Expected**: Accurate processed template size
- **Edge Cases**: Missing variables, template functions, UTF-8 characters

**3.3-UNIT-003: File Structure Size Calculation**
- **Priority**: P0
- **Description**: Sum file sizes + XML overhead + tree structure characters  
- **Input**: File metadata list with sizes
- **Expected**: Total with overhead calculations (XML tags, tree ASCII)
- **Edge Cases**: Binary files, very large files, deep directory structures

**3.3-UNIT-004: Size Formatting (KB/MB Display)**
- **Priority**: P1
- **Description**: Convert bytes to human-readable KB/MB format
- **Input**: Byte values (1024, 1048576, 2097152)
- **Expected**: "1.0 KB", "1.0 MB", "2.0 MB" 
- **Edge Cases**: Zero bytes, very large sizes, decimal precision

**3.3-UNIT-005: Warning Threshold Detection**
- **Priority**: P0
- **Description**: Classify sizes into warning levels
- **Input**: Various size values
- **Expected**: Correct warning levels (Normal <100KB, Large 100-500KB, Very Large 500KB-2MB, Excessive >2MB)
- **Edge Cases**: Boundary values (exactly 500KB, 2MB)
- **Mitigates**: DATA-001

#### Utility Functions

**3.3-UNIT-006: Timestamp Filename Generation**
- **Priority**: P1
- **Description**: Generate shotgun_prompt_YYYYMMDD_HHMM.md format
- **Input**: Current time
- **Expected**: Properly formatted filename with timestamp
- **Edge Cases**: Timezone handling, year boundaries

**3.3-UNIT-007: Filename Collision Detection**
- **Priority**: P2
- **Description**: Detect existing files and generate alternatives
- **Input**: Proposed filename, existing files list
- **Expected**: Unique filename with increment counter
- **Edge Cases**: Multiple collisions, permission issues

#### UI State Logic

**3.3-UNIT-008: ConfirmModel State Transitions**
- **Priority**: P1
- **Description**: Model state changes during calculation phases
- **Input**: State transition events (StartCalculation, ProgressUpdate, Complete)
- **Expected**: Correct state transitions and field updates
- **Edge Cases**: Invalid state transitions, concurrent updates

**3.3-UNIT-009: Progress Calculation**
- **Priority**: P1
- **Description**: Calculate progress percentage during file processing
- **Input**: Processed file count, total file count
- **Expected**: Accurate percentage (0-100%)
- **Edge Cases**: Division by zero, negative values

### Integration Tests (8 scenarios)

#### External Service Integration

**3.3-INT-001: Template Processing Integration**
- **Priority**: P0
- **Description**: Size estimator integrates with template engine for accurate processing
- **Setup**: Mock template with variables, real template engine
- **Test**: Call EstimatePromptSize, verify template processing occurs
- **Validation**: Size matches processed template character count
- **Mitigates**: TECH-001

**3.3-INT-002: File Size Data Integration**
- **Priority**: P0
- **Description**: Size estimator retrieves file sizes from FileTree metadata
- **Setup**: Mock FileTree with various file sizes
- **Test**: Request size estimation with file list
- **Validation**: File sizes correctly retrieved and summed
- **Mitigates**: DATA-002

**3.3-INT-003: Binary File Exclusion Integration**
- **Priority**: P1
- **Description**: Size calculation excludes binary files detected by scanner
- **Setup**: FileTree with mix of text and binary files
- **Test**: Calculate size estimation
- **Validation**: Binary files excluded from size calculation, shown in summary

#### UI Component Integration

**3.3-INT-004: AppState Data Synchronization** 
- **Priority**: P0
- **Description**: Confirmation screen displays current AppState data correctly
- **Setup**: AppState with template, files, task content, rules
- **Test**: Initialize confirmation screen
- **Validation**: All AppState data displayed accurately in UI

**3.3-INT-005: Screen Transition Integration**
- **Priority**: P1
- **Description**: F2 navigation preserves AppState and returns to rules screen
- **Setup**: Confirmation screen with data, F2 key event
- **Test**: Handle F2 navigation
- **Validation**: AppState preserved, screen transition to rules input

**3.3-INT-006: Progress Bar Update Integration**
- **Priority**: P1
- **Description**: Size calculation progress updates Bubbles progress component
- **Setup**: Long-running size calculation with progress callbacks
- **Test**: Monitor progress updates during calculation
- **Validation**: Progress bar updates smoothly without blocking UI
- **Mitigates**: PERF-003

**3.3-INT-007: Warning Display Integration**
- **Priority**: P0
- **Description**: Size thresholds trigger appropriate warning UI components
- **Setup**: Size estimation that exceeds warning thresholds  
- **Test**: Complete size calculation and display
- **Validation**: Warning UI appears with correct styling and messaging

#### Concurrency Integration

**3.3-INT-008: Goroutine Size Calculation Integration**
- **Priority**: P0
- **Description**: Concurrent file processing with progress tracking
- **Setup**: Large file set requiring concurrent processing
- **Test**: Start size calculation with progress monitoring
- **Validation**: Calculation completes correctly, progress updates received, no race conditions
- **Mitigates**: PERF-001, TECH-002

### E2E Tests (5 scenarios)

#### Critical User Journeys

**3.3-E2E-001: Complete Confirmation Flow**
- **Priority**: P0
- **Description**: Full user journey from rules to confirmation to generation trigger
- **Setup**: Complete application state with template, files, inputs
- **User Actions**:
  1. Navigate from rules input screen to confirmation
  2. View summary, size estimation, filename  
  3. Wait for size calculation completion
  4. Observe any warnings if applicable
  5. Press F10 to confirm generation
- **Validation**: 
  - All AC elements displayed correctly
  - Size calculation completes
  - Navigation to generation phase triggered
- **Performance**: Screen transition <500ms, size calculation <2s for typical file sets

#### Performance Validation

**3.3-E2E-002: Large File Set Performance Journey**
- **Priority**: P1  
- **Description**: User experience with large file set (1000+ files)
- **Setup**: Project with 1000+ files selected
- **User Actions**:
  1. Navigate to confirmation screen
  2. Monitor size calculation progress
  3. Verify UI remains responsive
- **Validation**: 
  - Calculation completes within 2 seconds
  - Progress bar updates smoothly
  - UI remains interactive during calculation  
  - User can cancel if needed
- **Mitigates**: PERF-001

#### Error Handling Journeys

**3.3-E2E-003: File Permission Error Journey**
- **Priority**: P2
- **Description**: Graceful handling when size calculation encounters inaccessible files
- **Setup**: File set including files with restricted permissions
- **User Actions**:
  1. Navigate to confirmation screen
  2. Start size calculation
  3. Observe error handling
- **Validation**:
  - Error message displayed clearly
  - Accessible files still processed
  - Estimation provided with disclaimer
  - User can still proceed
- **Mitigates**: DATA-002

#### Navigation Journeys

**3.3-E2E-004: Back Navigation Journey**
- **Priority**: P1
- **Description**: User navigation back to rules screen preserves data
- **Setup**: Confirmation screen with calculated data
- **User Actions**:
  1. Review confirmation screen
  2. Press F2 to return to rules
  3. Modify rules content
  4. Return to confirmation
- **Validation**:
  - F2 navigation works correctly
  - Rules screen data preserved
  - Modified data reflected on return
  - Size recalculation triggered appropriately

#### Warning System Journey

**3.3-E2E-005: Large Output Warning Journey**
- **Priority**: P1
- **Description**: User experience with large output warnings
- **Setup**: File selection resulting in >500KB estimated output
- **User Actions**:
  1. Navigate to confirmation screen
  2. Review size estimation and warning
  3. Understand warning implications
  4. Decide whether to proceed or adjust
- **Validation**:
  - Warning appears prominently
  - Size breakdown helps user understand contributors  
  - Optimization suggestions clear
  - User can make informed decision
- **Mitigates**: BUS-001, DATA-001

## Recommended Execution Order

### Phase 1: Fail Fast (P0 Unit Tests)
1. 3.3-UNIT-001: EstimatePromptSize calculation
2. 3.3-UNIT-002: Template size calculation  
3. 3.3-UNIT-003: File structure size calculation
4. 3.3-UNIT-005: Warning threshold detection

### Phase 2: Core Integration (P0 Integration Tests)
1. 3.3-INT-001: Template processing integration
2. 3.3-INT-002: File size data integration
3. 3.3-INT-004: AppState synchronization
4. 3.3-INT-007: Warning display integration
5. 3.3-INT-008: Concurrent processing integration

### Phase 3: Critical Flows (P0 E2E Tests)
1. 3.3-E2E-001: Complete confirmation flow

### Phase 4: Secondary Features (P1 Tests)
1. All P1 unit tests (3.3-UNIT-004, 006, 008, 009)
2. All P1 integration tests (3.3-INT-003, 005, 006)
3. All P1 E2E tests (3.3-E2E-002, 004, 005)

### Phase 5: Edge Cases (P2 Tests)
1. 3.3-UNIT-007: Filename collision detection
2. 3.3-E2E-003: File permission error handling

## Test Data Requirements

### Size Calculation Test Data
- **Small template**: <1KB with minimal variables
- **Medium template**: 5-10KB with complex variables and functions
- **Large template**: >20KB with extensive content
- **Mixed file sets**: Combination of small text files, large code files, binary files
- **Edge cases**: Empty files, very large files (>100MB), special characters

### Performance Test Data  
- **Large file sets**: 1000+ files with realistic size distribution
- **Deep directories**: Nested folder structures >10 levels deep
- **Mixed file types**: Source code, documentation, assets, configuration

### Error Condition Test Data
- **Permission issues**: Files with restricted read access
- **Network files**: Files on network shares (if applicable)
- **Corrupted files**: Files with filesystem issues

## Test Environment Requirements

### Unit Test Environment
- **Isolation**: Mock all external dependencies
- **Speed**: Tests should complete in <100ms each  
- **Deterministic**: Consistent results across runs

### Integration Test Environment
- **Real components**: Use actual template engine, file system
- **Controlled data**: Predictable test fixtures
- **Cleanup**: Proper teardown after each test

### E2E Test Environment  
- **Full application**: Complete TUI application stack
- **Realistic data**: Representative project structures
- **Performance monitoring**: Timing and resource usage tracking

## Success Criteria

### Functional Criteria
- ✅ All 22 test scenarios pass
- ✅ 100% acceptance criteria coverage
- ✅ All P0 tests pass before release

### Performance Criteria
- ✅ Size calculation <2s for 1000 files
- ✅ UI responsiveness maintained during calculation
- ✅ Memory usage <100MB during large file processing

### Quality Criteria  
- ✅ Test execution time <5 minutes total
- ✅ No flaky tests (>95% pass rate)
- ✅ Clear test failure diagnostics

## Maintenance Considerations

### Test Maintenance
- **Update frequency**: Review when AC or architecture changes
- **Data refresh**: Update test fixtures quarterly
- **Performance baselines**: Adjust thresholds based on hardware improvements

### Test Debt Prevention
- **Atomic tests**: Each test validates single responsibility
- **Clear naming**: Test names describe exact scenario
- **Minimal mocking**: Use real components when possible
- **Documentation**: Maintain test rationale and setup instructions

---

**Test Design Complete**  
**Total Scenarios**: 22 (9 Unit, 8 Integration, 5 E2E)  
**Risk Coverage**: All identified risks mitigated through targeted testing  
**AC Coverage**: 100% with appropriate multi-level validation