# Test Design: Story 1.4 - Keyboard Navigation & Screen Transitions

**Date**: 2025-09-03  
**Designer**: Quinn (Test Architect)  
**Story**: Keyboard Navigation & Screen Transitions  
**Risk Profile**: High risk (TECH-001: State Management Complexity)  

---

## Test Strategy Overview

- **Total test scenarios**: 28
- **Unit tests**: 16 (57%) - Focus on logic validation
- **Integration tests**: 9 (32%) - Component interactions  
- **E2E tests**: 3 (11%) - Critical user journeys
- **Priority distribution**: P0: 10, P1: 12, P2: 4, P3: 2

**Strategy Rationale**: Heavy unit test focus addresses high-risk state management complexity (TECH-001). Integration tests validate screen interactions. Minimal but targeted E2E tests for critical navigation paths.

---

## Test Scenarios by Acceptance Criteria

### AC1: F1 key displays contextual help for current screen

**Risk Mitigation**: Addresses BUS-001 (User Experience Degradation)

| ID | Level | Priority | Test Scenario | Justification | Risk Mitigation |
|----|-------|----------|---------------|---------------|-----------------|
| 1.4-UNIT-001 | Unit | P1 | Help content selection logic per screen type | Pure logic - screen type → help content mapping | - |
| 1.4-UNIT-002 | Unit | P2 | Help content validation (exists, well-formed) | Data validation logic | - |
| 1.4-INT-001 | Integration | P1 | F1 key triggers help dialog display | Key handler → dialog component interaction | BUS-001 |
| 1.4-E2E-001 | E2E | P1 | User presses F1, sees contextual help for current screen | Critical UX validation across all screens | BUS-001 |

### AC2: F2 navigates to previous screen (disabled on first screen)

**Risk Mitigation**: Addresses TECH-001 (State Management) and TECH-002 (Key Handler Conflicts)

| ID | Level | Priority | Test Scenario | Justification | Risk Mitigation |
|----|-------|----------|---------------|---------------|-----------------|
| 1.4-UNIT-003 | Unit | P0 | canGoBack() logic validation per screen | Pure business logic - screen position validation | - |
| 1.4-UNIT-004 | Unit | P0 | Previous screen calculation logic | Pure logic - current screen → previous screen | - |
| 1.4-UNIT-005 | Unit | P1 | F2 disabled state on first screen | State-dependent behavior logic | TECH-002 |
| 1.4-INT-002 | Integration | P0 | F2 key handler with screen transition | Key handler → navigation system interaction | TECH-001, TECH-002 |
| 1.4-INT-003 | Integration | P0 | State preservation during backward navigation | State manager → screen models interaction | TECH-001 |

### AC3: F3 advances to next screen with validation

**Risk Mitigation**: Addresses TECH-001 (State Management) and BUS-001 (UX Degradation)

| ID | Level | Priority | Test Scenario | Justification | Risk Mitigation |
|----|-------|----------|---------------|---------------|-----------------|
| 1.4-UNIT-006 | Unit | P0 | canAdvance() validation rules per screen | Complex business logic - validation per screen type | - |
| 1.4-UNIT-007 | Unit | P0 | Next screen calculation logic | Pure logic - current screen + validation → next screen | - |
| 1.4-UNIT-008 | Unit | P1 | Validation failure error message generation | Business logic - validation state → error messages | BUS-001 |
| 1.4-INT-004 | Integration | P0 | F3 key handler with validation and transition | Key handler → validation → navigation | TECH-001, TECH-002 |
| 1.4-INT-005 | Integration | P1 | Validation failure blocks navigation with error display | Validation → error UI interaction | BUS-001 |
| 1.4-E2E-002 | E2E | P0 | User completes forward navigation with valid data | Critical happy path validation | TECH-001 |

### AC4: ESC key shows exit confirmation dialog

**Risk Mitigation**: Addresses TECH-002 (Key Handler Conflicts) and BUS-001 (UX)

| ID | Level | Priority | Test Scenario | Justification | Risk Mitigation |
|----|-------|----------|---------------|---------------|-----------------|
| 1.4-UNIT-009 | Unit | P1 | Exit confirmation dialog state management | Dialog state logic | - |
| 1.4-UNIT-010 | Unit | P2 | Exit choice handling (Yes/No/Cancel) | Pure logic - choice → action mapping | - |
| 1.4-INT-006 | Integration | P1 | ESC key triggers exit confirmation dialog | Key handler → dialog component | TECH-002 |
| 1.4-INT-007 | Integration | P2 | Exit confirmation handles unsaved data warnings | Dialog → data state interaction | BUS-001 |

### AC5: Screen state persists when navigating back and forth

**Risk Mitigation**: Primary mitigation for TECH-001 (State Management Complexity)

| ID | Level | Priority | Test Scenario | Justification | Risk Mitigation |
|----|-------|----------|---------------|---------------|-----------------|
| 1.4-UNIT-011 | Unit | P0 | AppState constructor with screen models | State initialization logic | TECH-001 |
| 1.4-UNIT-012 | Unit | P0 | State preservation during screen swaps | Core state management logic | TECH-001 |
| 1.4-UNIT-013 | Unit | P0 | State integrity validation after transitions | State validation logic | TECH-001 |
| 1.4-UNIT-014 | Unit | P1 | Shared data persistence (SelectedFiles, TaskContent) | Shared state logic | TECH-001 |
| 1.4-INT-008 | Integration | P0 | Forward→backward→forward navigation preserves state | Multi-transition state persistence | TECH-001 |
| 1.4-INT-009 | Integration | P1 | State restoration with partially completed screens | Complex state scenarios | TECH-001 |
| 1.4-E2E-003 | E2E | P0 | User navigates full cycle with data preservation | End-to-end state validation | TECH-001 |

### AC6: Progress indicator shows current screen (1/5, 2/5, etc.)

**Risk Mitigation**: UX enhancement - moderate priority

| ID | Level | Priority | Test Scenario | Justification | Risk Mitigation |
|----|-------|----------|---------------|---------------|-----------------|
| 1.4-UNIT-015 | Unit | P2 | Progress calculation logic (screen → X/5 format) | Pure calculation logic | - |
| 1.4-UNIT-016 | Unit | P2 | Progress bar visualization generation | Display logic | - |

### AC7: Proper focus management when entering each screen

**Risk Mitigation**: Addresses TECH-003 (Focus Management Race Conditions)

| ID | Level | Priority | Test Scenario | Justification | Risk Mitigation |
|----|-------|----------|---------------|---------------|-----------------|
| 1.4-UNIT-017 | Unit | P3 | Focus initialization commands per screen type | Screen-specific focus logic | TECH-003 |
| 1.4-UNIT-018 | Unit | P3 | Focus restoration logic for returning screens | Focus state logic | TECH-003 |

---

## Risk Coverage Matrix

**High Priority Risk Mitigation:**

| Risk ID | Risk Description | Test Scenarios | Mitigation Strength |
|---------|------------------|----------------|---------------------|
| TECH-001 | State Management Complexity | 1.4-UNIT-011/012/013/014, 1.4-INT-002/003/004/008/009, 1.4-E2E-003 | **STRONG** - 10 scenarios |
| TECH-002 | Key Handler Conflicts | 1.4-INT-001/002/004/006 | **ADEQUATE** - 4 scenarios |
| BUS-001 | UX Degradation | 1.4-UNIT-008, 1.4-INT-001/005/007, 1.4-E2E-001 | **ADEQUATE** - 5 scenarios |
| TECH-003 | Focus Management | 1.4-UNIT-017/018 | **BASIC** - 2 scenarios |

---

## Detailed Test Specifications

### Priority 0 Tests (Must Pass)

#### State Management Core Tests
**1.4-UNIT-011: AppState Constructor Validation**
```yaml
Given: AppState constructor called with screen configuration
When: NewApp() creates initial state
Then: All screen models initialized with proper defaults
  And: Shared data structures properly initialized
  And: CurrentScreen set to FileTreeScreen
  And: State passes integrity validation
```

**1.4-UNIT-012: State Preservation Logic**  
```yaml
Given: AppState with populated screen data
When: Screen transition requested
Then: Current screen model preserved in AppState
  And: Shared data maintained correctly
  And: Navigation state updated appropriately
```

**1.4-UNIT-013: State Integrity Validation**
```yaml
Given: AppState after multiple transitions
When: State integrity check performed
Then: All screen models maintain data consistency
  And: Shared data references are valid
  And: No state corruption detected
```

#### Navigation Core Tests
**1.4-UNIT-006: Screen Validation Rules**
```yaml
Given: Current screen and user data state
When: canAdvance() validation executed
Then: Validation rules applied correctly per screen:
  - FileTree: len(SelectedFiles) > 0
  - Template: SelectedTemplate != nil
  - TaskInput: TaskContent != ""
  - RulesInput: true (always valid)
  - Confirm: false (final screen)
```

**1.4-INT-008: Multi-Transition State Persistence**
```yaml
Given: User on Template screen with selected template
When: Navigate back to FileTree then forward to Template
Then: Template selection preserved
  And: FileTree selections maintained
  And: No data loss during navigation cycle
```

### Priority 1 Tests (Core Functionality)

#### User Experience Tests
**1.4-E2E-001: Contextual Help System**
```yaml
Given: User on each screen (FileTree, Template, TaskInput, RulesInput, Confirm)
When: User presses F1 key
Then: Help dialog appears with screen-specific content
  And: Help content is relevant to current screen
  And: Dialog can be dismissed properly
```

**1.4-E2E-002: Forward Navigation Happy Path**
```yaml  
Given: User with valid data on each screen
When: User presses F3 to advance through all screens
Then: User successfully navigates: FileTree → Template → TaskInput → RulesInput → Confirm
  And: All data preserved throughout journey
  And: Progress indicator updates correctly
```

### Priority 2 Tests (UX Enhancement)

#### Progress & Focus Tests  
**1.4-UNIT-015: Progress Indicator Calculation**
```yaml
Given: Current screen position
When: Progress display requested
Then: Correct format displayed:
  - FileTree: "1/5"
  - Template: "2/5" 
  - TaskInput: "3/5"
  - RulesInput: "4/5"
  - Confirm: "5/5"
```

---

## Recommended Test Execution Order

### Phase 1: Critical Path Validation (P0)
1. **State Management Unit Tests**: 1.4-UNIT-011, 012, 013 (TECH-001 mitigation)
2. **Validation Logic Tests**: 1.4-UNIT-003, 004, 006, 007 (Navigation core)
3. **Integration State Tests**: 1.4-INT-002, 003, 004, 008 (State + Navigation)
4. **E2E State Validation**: 1.4-E2E-003 (End-to-end validation)

### Phase 2: Core Functionality (P1) 
1. **User Experience Tests**: 1.4-E2E-001, 002 (UX validation)
2. **Error Handling Tests**: 1.4-UNIT-008, 1.4-INT-005, 007 (Error scenarios)
3. **Key Handler Tests**: 1.4-INT-001, 006 (UI interactions)

### Phase 3: Enhancement Validation (P2)
1. **Progress Indicator Tests**: 1.4-UNIT-015, 016 (UX polish)
2. **Exit Dialog Tests**: 1.4-UNIT-009, 010 (Secondary flows)

### Phase 4: Robustness (P3)
1. **Focus Management Tests**: 1.4-UNIT-017, 018 (Edge cases)

---

## Test Data Requirements

### AppState Test Fixtures
```yaml
minimal_state:
  current_screen: FileTreeScreen
  file_tree: empty_model
  selected_files: []
  
populated_state:
  current_screen: TemplateScreen
  file_tree: with_selected_files
  selected_files: ["file1.go", "file2.go"]
  selected_template: "analyze_bug"
  
complete_state:
  current_screen: ConfirmScreen
  file_tree: with_selections
  selected_files: ["file1.go", "file2.go"]
  selected_template: "analyze_bug"
  task_content: "Fix the authentication bug"
  rules_content: "Follow security guidelines"
```

### Navigation Test Scenarios
```yaml
forward_navigation:
  - FileTree (valid: has selected files) → Template
  - Template (valid: has selected template) → TaskInput
  - TaskInput (valid: has task content) → RulesInput
  - RulesInput (always valid) → Confirm
  
backward_navigation:
  - Template → FileTree
  - TaskInput → Template  
  - RulesInput → TaskInput
  - Confirm → RulesInput
  
invalid_navigation:
  - FileTree (no files selected) blocked from advancing
  - Template (no template selected) blocked from advancing
  - TaskInput (no task content) blocked from advancing
```

---

## Test Environment Setup

### Unit Test Setup
- **Framework**: Go testing standard library
- **Mocks**: Screen model mocks for isolation
- **Test Data**: JSON fixtures for AppState variations
- **Coverage Target**: 90% minimum per coding standards

### Integration Test Setup
- **Framework**: Go testing + teatest for TUI components  
- **Components**: Real screen models with test data
- **Key Simulation**: teatest key event simulation
- **Assertions**: State verification, UI response validation

### E2E Test Setup
- **Framework**: teatest full application testing
- **Environment**: Complete application instance
- **Data**: Representative user scenarios
- **Validation**: Full workflow completion verification

---

## Quality Validation Checklist

- ✅ **Every AC has test coverage**: All 7 ACs covered with 28 scenarios
- ✅ **Test levels are appropriate**: Unit-heavy for logic, minimal E2E for critical paths  
- ✅ **No duplicate coverage**: Clear level separation maintained
- ✅ **Priorities align with risk**: P0 tests focus on TECH-001 high-risk area
- ✅ **Test IDs follow convention**: Format: {epic}.{story}-{LEVEL}-{SEQ}
- ✅ **Scenarios are atomic**: Each test validates single behavior
- ✅ **Risk mitigation addressed**: High-priority risks have comprehensive coverage

---

## Coverage Gaps Analysis

**✅ NO COVERAGE GAPS IDENTIFIED**

- All acceptance criteria have dedicated test scenarios
- High-risk areas (TECH-001) have comprehensive multi-level coverage  
- Critical user journeys covered by E2E tests
- Error scenarios and edge cases addressed at appropriate levels

---

## Test Maintenance Considerations

### Long-term Sustainability
- **Unit Tests**: Stable - pure logic changes infrequently
- **Integration Tests**: Medium maintenance - component interactions may evolve
- **E2E Tests**: High maintenance - UI changes require updates

### Test Evolution Triggers
- New screen types added to navigation flow
- Validation rules change for existing screens
- Key binding modifications
- State management architecture changes
- Performance optimization refactoring

---

## Success Metrics

### Test Execution Metrics
- **P0 Test Pass Rate**: Must be 100% before deployment
- **Overall Test Pass Rate**: Target >95% for release approval
- **Test Execution Time**: P0 tests <30s, full suite <2min
- **Code Coverage**: >90% for navigation and state management modules

### Quality Metrics  
- **Defect Escape Rate**: <5% post-implementation bugs related to navigation
- **User Experience Metrics**: Navigation flow completion rate >95%
- **Performance Metrics**: Screen transition time <100ms average

---

## Integration with Quality Gates

**Test Design Completeness**: ✅ **PASS**  
- Comprehensive coverage of all acceptance criteria
- Risk-based prioritization implemented  
- Appropriate test level distribution
- Clear execution strategy defined

This test design directly supports the quality gate decision by providing:
1. **Concrete mitigation** for TECH-001 high-risk area through extensive state management testing
2. **Balanced coverage** across all functionality areas
3. **Efficient execution strategy** with P0 focus for fast feedback
4. **Clear quality metrics** for gate decision validation