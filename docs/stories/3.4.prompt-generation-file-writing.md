# Story 3.4: Prompt Generation & File Writing

## Status  
**Done**

## Story
**As a** user,
**I want** the final prompt saved to a file,
**so that** I can use it with my preferred LLM tool.

## Acceptance Criteria
1: Combine template + variables + file structure into final output
2: Save to current directory with timestamp filename (shotgun_prompt_YYYYMMDD_HHMM.md)
3: Ensure no filename collisions with incrementing counter if needed
4: Display success message with full file path
5: Handle write errors gracefully with clear error message
6: Non-blocking generation using goroutines
7: Progress indicator during file writing for large outputs

## Tasks / Subtasks

- [x] **Task 1: Create Prompt Generator Service** (AC: 1)
  - [x] Create `internal/core/builder/generator.go` with PromptGenerator struct
  - [x] Implement GeneratePrompt(config GenerationConfig) (*GeneratedPrompt, error) function
  - [x] Combine processed template with file structure from existing assembler
  - [x] Add NewPromptGenerator() constructor following existing patterns
  - [x] Implement proper error handling for generation failures

- [x] **Task 2: Implement File Writing System** (AC: 2,3,5)
  - [x] Create `internal/core/builder/writer.go` for file output operations
  - [x] Implement WritePromptFile(content, filename string) (string, error) function
  - [x] Generate timestamp-based filename: `shotgun_prompt_YYYYMMDD_HHMM.md`
  - [x] Add collision detection and incrementing counter logic
  - [x] Implement file permission and directory validation
  - [x] Add comprehensive error handling for write operations

- [x] **Task 3: Add Async Generation Support** (AC: 6,7)
  - [x] Create generation command for Bubble Tea message system
  - [x] Implement progress tracking during file writing for large outputs
  - [x] Add context cancellation support for user-initiated cancellation
  - [x] Use goroutines for non-blocking prompt generation
  - [x] Implement proper Bubble Tea command pattern for async operations

- [x] **Task 4: Create Generation Screen Component** (AC: 4,7)
  - [x] Create `internal/screens/generate/model.go` with GenerateModel struct
  - [x] Implement generation progress display with spinner or progress bar
  - [x] Add success screen with file path display and completion message
  - [x] Include error display screen for generation failures
  - [x] Add keyboard navigation (F1 to restart, Esc to exit)

- [x] **Task 5: Integration with App State Flow** (AC: 1,4)
  - [x] Connect GenerateModel with AppState for accessing all collected data
  - [x] Implement screen transition from confirmation → generation
  - [x] Update AppState with generation results and output file path
  - [x] Add generation screen to main app routing logic
  - [x] Handle async generation with proper Bubble Tea command flow

- [x] **Task 6: Add Success and Error Handling** (AC: 4,5)
  - [x] Display detailed success message with full file path and size
  - [x] Show file generation statistics (template size, file count, total size)
  - [x] Implement comprehensive error messages for different failure types
  - [x] Add retry mechanism for recoverable errors (e.g., temporary file locks)
  - [x] Support user action options on completion (open file, restart, exit)

- [x] **Task 7: Unit Testing** (AC: All)
  - [x] Create `internal/core/builder/generator_test.go` for prompt generation tests
  - [x] Create `internal/core/builder/writer_test.go` for file writing tests
  - [x] Create `internal/screens/generate/model_test.go` for generation screen tests
  - [x] Test filename collision detection and counter incrementing
  - [x] Test error handling for various write failure scenarios
  - [x] Test async generation with mock AppState data
  - [x] Test progress tracking and cancellation scenarios

## Dev Notes

### Previous Story Insights
From Stories 3.1, 3.2, and 3.3 completion:
- Template processing engine fully operational with variable substitution system
- File structure assembly system implemented with concurrent file reading and XML wrapping
- Size estimation system implemented with progress tracking and warning thresholds
- AppState contains all necessary data: SelectedTemplate, TaskContent, RulesContent, SelectedFiles, EstimatedOutputSize
- Confirmation screen validates selections and prepares for generation
- Complete prompt assembly pipeline established and ready for final generation step

### Data Models

**GenerationConfig Structure** [Source: architecture/data-models.md#appstate]:
```go
type GenerationConfig struct {
    Template      *Template
    Variables     map[string]string
    SelectedFiles []string
    TaskContent   string
    RulesContent  string
    OutputPath    string
}
```

**GeneratedPrompt Structure**:
```go
type GeneratedPrompt struct {
    Content       string
    TemplateSize  int64
    FileCount     int
    TotalSize     int64
    GeneratedAt   time.Time
}
```

**GenerateModel Structure** [Source: architecture/frontend-architecture.md#component-template]:
```go
type GenerateModel struct {
    // Generation state
    generating    bool
    progress      progress.Model
    spinner       spinner.Model
    
    // Results
    completed     bool
    outputFile    string
    generatedSize int64
    error         error
    
    // UI state
    viewport      viewport.Model
    showStats     bool
}
```

**AppState Integration** [Source: architecture/data-models.md#appstate]:
- AppState.SelectedTemplate (*Template) - Template for final processing
- AppState.SelectedFiles ([]string) - Files for content inclusion
- AppState.TaskContent (string) - User task input for TASK variable
- AppState.RulesContent (string) - User rules input for RULES variable
- AppState.EstimatedOutputSize (int64) - Pre-calculated size estimate
- AppState.OutputFilename (string) - Generated filename from confirmation screen

### Component Specifications

**Generation Screen Component** [Source: architecture/frontend-architecture.md#component-organization]:
```
internal/screens/generate/
├── model.go       # GenerateModel state structure
├── update.go      # Message handling for async generation
├── view.go        # Rendering logic for progress and results
└── commands.go    # Bubble Tea commands for generation flow
```

**Prompt Generator Service** [Source: architecture/components.md#prompt-builder]:
- Responsibility: Combine template, variables, and file structure into final prompt
- Key Interfaces:
  - GeneratePrompt(config GenerationConfig) (*GeneratedPrompt, error) - Main generation function
  - ProcessTemplate(template, variables) (string, error) - Template processing with variables
  - AssembleFileStructure(files []string) (string, error) - File content assembly
- Dependencies: Template engine, file structure builder, file system
- Performance: Must handle large outputs efficiently with progress tracking

**File Writer Service**:
```go
type FileWriter interface {
    WritePromptFile(content string, basePath string) (string, error)
    GenerateFilename(timestamp time.Time) string
    CheckCollisions(filename string) string
    ValidateWritePermissions(path string) error
}
```

### API Specifications

**Prompt Generation Interface**:
```go
type PromptGenerator interface {
    GeneratePrompt(ctx context.Context, config GenerationConfig) (*GeneratedPrompt, error)
    GenerateAsync(config GenerationConfig, callback ProgressCallback) tea.Cmd
}

type ProgressCallback func(stage string, progress float64)

type GenerationStage string
const (
    StageProcessingTemplate  GenerationStage = "Processing template"
    StageLoadingFiles       GenerationStage = "Loading file contents"
    StageAssemblingStructure GenerationStage = "Assembling file structure"
    StageWritingOutput      GenerationStage = "Writing output file"
    StageComplete           GenerationStage = "Generation complete"
)
```

**File Writing Interface** [Source: architecture/tech-stack.md#technology-stack-table]:
- Use Go standard library for file operations with proper error handling
- Implement atomic file writing with temp file + rename pattern
- Support context cancellation for long-running write operations
- Provide detailed progress updates for large file operations

### File Locations

**Generation Screen Components** [Source: architecture/unified-project-structure.md]:
- `internal/screens/generate/model.go` - GenerateModel state structure
- `internal/screens/generate/update.go` - Message handling and async generation
- `internal/screens/generate/view.go` - UI rendering for progress and results
- `internal/screens/generate/commands.go` - Bubble Tea command implementations

**Prompt Generation Service** [Source: architecture/unified-project-structure.md]:
- `internal/core/builder/generator.go` - Main prompt generation logic
- `internal/core/builder/writer.go` - File writing and collision handling
- `internal/core/builder/generator_test.go` - Prompt generation tests
- `internal/core/builder/writer_test.go` - File writing tests

**Testing Files** [Source: architecture/testing-strategy.md#frontend-tests]:
- Tests co-located: `model_test.go`, `update_test.go`, `view_test.go`
- Test fixtures: `internal/screens/generate/testdata/` for mock generation data
- Integration tests: End-to-end generation flow with real file system

### Technical Constraints

**File Writing Performance** [Source: architecture/coding-standards.md#critical-fullstack-rules]:
- Use atomic file operations (write to temp file, then rename) for safety
- Implement proper file locking to prevent concurrent write issues
- Handle disk space checks before writing large files
- Context cancellation support for responsive user cancellation
- Streaming writes for very large outputs to manage memory usage

**Error Handling Standards** [Source: architecture/coding-standards.md#critical-fullstack-rules]:
- All functions that can fail must return error as last value
- Detailed error messages for different failure types (permissions, disk space, etc.)
- Graceful handling of partial write failures with cleanup
- Never panic during file operations or generation
- Proper error propagation through Bubble Tea message system

**Concurrency Requirements** [Source: architecture/tech-stack.md#technology-stack-table]:
- Bubble Tea message-driven architecture for non-blocking generation
- Goroutine-based generation with proper context handling
- Progress updates must not impact screen rendering performance
- Channel-based communication between generation goroutines and UI
- Proper cleanup of goroutines on cancellation or completion

### Generation Logic Flow

**Template Processing Integration** [Source: Stories 3.1, 3.2, 3.3 context]:
1. Use existing ProcessTemplate functionality from Story 3.1 completion
2. Populate variables: TASK (TaskContent), RULES (RulesContent), FILE_STRUCTURE (from assembler)
3. Add automatic variables: CURRENT_DATE, PROJECT_NAME, SELECTED_FILES_COUNT
4. Handle template processing errors with proper error messages
5. Process conditional sections and template functions correctly

**File Structure Assembly Integration** [Source: Story 3.2 completion]:
1. Leverage existing FileStructureBuilder for content assembly
2. Use existing binary file detection and XML wrapping functionality
3. Maintain file order consistency with tree display from confirmation screen
4. Preserve exact file content formatting and whitespace
5. Handle large files with streaming reads to manage memory

**Final Output Assembly**:
```
1. Process template with all variables → processed_template
2. Assemble file structure with selected files → file_structure
3. Combine: processed_template + file_structure → final_output
4. Write to timestamped filename with collision handling
5. Report success with file path and generation statistics
```

**Filename Generation Logic**:
- Base format: `shotgun_prompt_YYYYMMDD_HHMM.md`
- Example: `shotgun_prompt_20250904_1425.md`
- Collision handling: Add counter suffix `_1`, `_2`, etc.
- Final example with collision: `shotgun_prompt_20250904_1425_1.md`

### Integration Points

**Template Engine Integration** [Source: Story 3.1 completion]:
- Use existing ProcessTemplate function with current variables
- Handle template processing errors gracefully during generation
- Reuse template function library for consistent processing
- Maintain compatibility with all template features (conditionals, functions)

**File Structure Builder Integration** [Source: Story 3.2 completion]:
- Use FileStructureBuilder.Build() for final file structure assembly
- Leverage existing concurrent file processing for large sets
- Maintain XML format consistency: `<file path="...">content</file>`
- Handle binary file exclusions consistently with confirmation screen

**Size Estimator Integration** [Source: Story 3.3 completion]:
- Compare actual generated size with estimated size for validation
- Use estimation for progress calculation during generation
- Report size accuracy in completion statistics
- Validate memory usage predictions for large outputs

**Screen Flow Integration** [Source: architecture/frontend-architecture.md#routing-architecture]:
- Transition from Confirmation Screen with F10 key press
- Handle generation completion with success/error screens
- Support return navigation to file selection or restart flow
- AppState synchronization during final generation phase

### UI Layout Design

**Generation Progress Screen**:
```
┌─ Generating Prompt ────────────────────────────┐
│ Processing template...                         │
│ ████████████████████████░░░░░░░░ 75%          │
│                                                │
│ Template: "Fix Authentication Bug" v1.2       │
│ Files: 12 selected                            │
│ Estimated size: 51.1 KB                       │
│                                                │
│ Press Esc to cancel                            │
└───────────────────────────────────────────────┘
```

**Success Screen**:
```
┌─ Generation Complete ──────────────────────────┐
│ ✓ Prompt successfully generated!               │
│                                                │
│ File: shotgun_prompt_20250904_1425.md         │
│ Path: /current/directory/shotgun_prompt...    │
│ Size: 52.3 KB (estimate was 51.1 KB)         │
│                                                │
│ Template processed: 2.1 KB                    │
│ Files included: 12 files, 50.2 KB            │
│                                                │
│ F1: Start over  F2: Open file  Esc: Exit     │
└───────────────────────────────────────────────┘
```

**Error Screen**:
```
┌─ Generation Failed ────────────────────────────┐
│ ✗ Failed to generate prompt                   │
│                                                │
│ Error: Permission denied writing to file      │
│ Path: /protected/directory/                    │
│                                                │
│ Suggestions:                                   │
│ • Check directory write permissions           │
│ • Ensure sufficient disk space available      │
│ • Try selecting a different output location   │
│                                                │
│ F5: Retry  F1: Start over  Esc: Exit         │
└───────────────────────────────────────────────┘
```

### Keyboard Navigation

**Generation Screen Keys** [Source: architecture/frontend-architecture.md#protected-route-pattern]:
- **Escape**: Cancel generation (if in progress) or exit (if complete)
- **F1**: Return to File Tree Screen for restart
- **F2**: Open generated file in system default application (success screen only)
- **F5**: Retry generation (error screen only)
- **Enter**: Continue to next action (context-sensitive)

### Testing Requirements

**Test Coverage Areas** [Source: architecture/testing-strategy.md#frontend-tests]:
- Prompt generation accuracy with various template and file combinations
- File writing functionality including collision detection and atomic operations
- Progress tracking during generation with mock progress callbacks
- Error handling for different failure scenarios (permissions, disk space, template errors)
- Async generation with Bubble Tea command integration
- Success and error screen display with proper state management
- Filename generation and timestamp formatting
- AppState integration and final data synchronization

**Performance Testing**:
- Generation performance with large file sets and templates
- Memory usage during assembly of very large outputs
- File writing performance for different output sizes
- UI responsiveness during long-running generation operations
- Cancellation responsiveness during generation process

**Integration Testing**:
- End-to-end flow from confirmation → generation → completion
- Template engine integration with all variable types and functions
- File structure builder integration with concurrent file processing
- Error propagation through entire generation pipeline
- File system integration with various permissions and disk conditions

## Testing

Test files must be co-located with source files in appropriate directories:
- `internal/screens/generate/model_test.go` - Generation screen state management
- `internal/screens/generate/update_test.go` - Message handling and async operations
- `internal/screens/generate/view_test.go` - UI rendering and layout tests
- `internal/core/builder/generator_test.go` - Prompt generation logic tests
- `internal/core/builder/writer_test.go` - File writing and collision handling tests
- Test coverage minimum 90% for generation components and file operations
- Integration tests with real file system operations and template processing
- Performance benchmarks for generation with various output sizes

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
None

### Completion Notes
- Successfully implemented all 7 tasks for Story 3.4
- Created comprehensive prompt generation and file writing system
- Integrated generation screen with main application flow
- All unit tests passing with good coverage
- Fixed circular import issues by simplifying template processing
- Implemented atomic file writing with collision detection
- Added comprehensive error handling and progress tracking
- Generation screen includes success/error states with appropriate user actions

### File List
#### Core Services
- `internal/core/builder/generator.go` - Main prompt generation service
- `internal/core/builder/writer.go` - File writing and collision handling
- `internal/core/builder/generator_test.go` - Generator unit tests
- `internal/core/builder/writer_test.go` - Writer unit tests

#### UI Components
- `internal/screens/generate/model.go` - Generation screen state management
- `internal/screens/generate/update.go` - Message handling and async operations
- `internal/screens/generate/view.go` - UI rendering for progress and results
- `internal/screens/generate/commands.go` - Bubble Tea command implementations
- `internal/screens/generate/model_test.go` - Generation screen unit tests

#### Application Integration
- `internal/app/model.go` - Updated to include GenerateScreen and GenerateModel
- `internal/app/update.go` - Added generation screen routing and message handling
- `internal/app/view.go` - Added generation screen rendering

### Testing Results
- All builder package tests passing (52 tests)
- All generate screen tests passing (11 tests)
- 100% implementation coverage for acceptance criteria
- Comprehensive error handling and edge case testing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-04 | 3.4.0 | Initial story creation with comprehensive architecture context | Bob (Scrum Master) |
| 2025-09-04 | 3.4.1 | Story approved after comprehensive validation - ready for implementation | Sarah (Product Owner) |
| 2025-09-04 | 3.4.2 | Story implementation completed - all tasks finished, tests passing | James (Dev Agent) |

## QA Results

### Review Date: 2025-09-04

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation of Story 3.4 with comprehensive prompt generation and file writing system. The code demonstrates solid architectural patterns, proper error handling, and follows Go best practices throughout. The async generation system with Bubble Tea integration is well-designed and maintains UI responsiveness. File operations use atomic writes for data safety, and the collision handling system is robust.

### Refactoring Performed

No refactoring was required during this review. The implementation already follows best practices and maintains high code quality standards.

### Compliance Check

- Coding Standards: ✓ All functions return errors appropriately, context cancellation implemented, no panics in library code
- Project Structure: ✓ Files properly organized in internal packages with clear separation of concerns
- Testing Strategy: ✓ Comprehensive coverage with 63 total tests (52 builder + 11 generate screen tests)
- All ACs Met: ✓ All 7 acceptance criteria fully implemented and validated

### Improvements Checklist

All items were already properly implemented:

- [x] Atomic file writing with temp file + rename pattern implemented
- [x] Comprehensive error handling throughout generation pipeline
- [x] Context cancellation support for responsive user experience
- [x] Progress tracking without blocking UI rendering
- [x] Filename collision detection and counter incrementing
- [x] Full Bubble Tea integration with proper message handling
- [x] Success/error screens with appropriate user actions

### Security Review

No security concerns identified. File operations properly validate permissions, atomic writes prevent corruption, and no sensitive data is exposed or logged.

### Performance Considerations

Performance is well-optimized with async generation using goroutines, non-blocking UI updates, context-based cancellation, and efficient file operations. Memory usage is well-managed during large file operations.

### Files Modified During Review

No files were modified during this review. The implementation was already of high quality.

### Gate Status

Gate: PASS → docs/qa/gates/3.4-prompt-generation-file-writing.yml
Risk profile: Low risk - well-implemented feature with comprehensive testing
NFR assessment: All NFRs (security, performance, reliability, maintainability) fully satisfied

### Recommended Status

✓ Ready for Done - All acceptance criteria met with excellent implementation quality